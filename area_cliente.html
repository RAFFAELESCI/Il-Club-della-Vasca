import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, orderBy, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const auth = getAuth(app);
const db = getFirestore(app);

let userDocId = null;

// Rileva se il cliente Ã¨ loggato
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert('Devi accedere per vedere la tua area personale.');
    location.href = 'login_clienti.html';
    return;
  }

  const userEmail = user.email;

  // Trova il documento corrispondente nel DB usando l'email
  const usersCol = collection(db, "users");
  const snapshot = await getDocs(usersCol);
  let found = null;
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if(data.email === userEmail){
      found = { id: docSnap.id, data };
    }
  });

  if(!found){
    alert('Utente non trovato.');
    location.href = 'login_clienti.html';
    return;
  }

  userDocId = found.id;
  const data = found.data;

  // Aggiorna UI
  nicknameEl.textContent = data.nickname || "Cliente";
  userPhoto.src = data.photoUrl || "https://via.placeholder.com/120?text=No+Photo";
  drinkCountNumber.textContent = data.drinkCount || 0;
  totalDrinksEl.textContent = data.totalDrinks || 0;

  updateRanking();

  // Listener realtime per drinkCount e totalDrinks
  const userRef = doc(db, "users", userDocId);
  onSnapshot(userRef, docSnap => {
    if(!docSnap.exists()) return;
    const d = docSnap.data();
    drinkCountNumber.textContent = d.drinkCount || 0;
    totalDrinksEl.textContent = d.totalDrinks || 0;
    if ((d.drinkCount || 0) >= 10) showBanner();
    else hideBanner();
    updateRanking();
  });
});
