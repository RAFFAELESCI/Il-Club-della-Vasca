<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Area Cliente - Club della Vasca</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');
  @font-face {
    font-family: 'Ransel';
    src: url('/fonts/Ransel.ttf') format('truetype');
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Ransel', 'Montserrat', sans-serif;
    background-color: #171716;
    color: #EACE3E;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }
  header {
    text-align: center;
    margin-bottom: 30px;
  }
  #userPhoto {
    width: 120px;
    height: 120px;
    border-radius: 60px;
    object-fit: cover;
    border: 3px solid #D69327;
    margin-bottom: 10px;
  }
  #nickname {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
  }
  #drinkCountSection {
    background-color: #2A2A29;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    width: 100%;
    max-width: 320px;
    margin-bottom: 30px;
    box-shadow: 0 0 15px #D69327;
  }
  #drinkCountNumber {
    font-size: 6rem;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 10px;
    color: #D69327;
  }
  #drinkCountLabel {
    font-size: 1.5rem;
  }
  #totalDrinksSection {
    background-color: #2A2A29;
    border-radius: 12px;
    padding: 20px;
    width: 100%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 0 10px #EACE3E;
  }
  #totalDrinks {
    font-size: 3rem;
    font-weight: 700;
    color: #A2231A;
  }
  #ranking {
    font-size: 1.2rem;
    margin-top: 8px;
  }
  #banner {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #D69327;
    color: #171716;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 25px #A2231A;
    max-width: 360px;
    width: 90%;
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 10000;
  }
  #banner p {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 15px;
    text-align: center;
  }
  #passwordInput {
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-size: 1.1rem;
    width: 100%;
    margin-bottom: 15px;
    text-align: center;
  }
  #resetBtn {
    background-color: #A2231A;
    color: #EACE3E;
    border: none;
    padding: 12px;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }
  #resetBtn:hover {
    background-color: #7F1B15;
  }
  #errorMsg {
    color: #7F1B15;
    font-weight: 700;
    margin-bottom: 10px;
    height: 1.2em;
    text-align: center;
  }
</style>
</head>
<body>

<header>
  <img id="userPhoto" src="" alt="Foto cliente" />
  <div id="nickname">Caricamento...</div>
</header>

<section id="drinkCountSection" aria-live="polite" aria-atomic="true">
  <div id="drinkCountNumber">0</div>
  <div id="drinkCountLabel">Drink Count</div>
</section>

<section id="totalDrinksSection" aria-live="polite" aria-atomic="true">
  <div>Totale Drink Consumati</div>
  <div id="totalDrinks">0</div>
  <div id="ranking">Classifica: --</div>
</section>

<!-- Banner omaggio -->
<div id="banner" role="alertdialog" aria-modal="true" aria-labelledby="bannerTitle" aria-describedby="bannerDesc">
  <p id="bannerTitle">Complimenti! Hai diritto a un drink omaggio ðŸŽ‰</p>
  <p id="bannerDesc">Inserisci la password per azzerare il conteggio e concedere il drink</p>
  <input type="password" id="passwordInput" placeholder="Password admin" aria-label="Password per azzerare il conteggio" />
  <div id="errorMsg" aria-live="assertive"></div>
  <button id="resetBtn">Conferma</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc, collection, query, orderBy, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Config Firebase (metti la tua configurazione qui)
  const firebaseConfig = {
    apiKey: "AIzaSyDtSDqUKdsmID1MrN07BKoo6ZFe6ymisSg",
    authDomain: "il-club-della-vasca.firebaseapp.com",
    projectId: "il-club-della-vasca",
    storageBucket: "il-club-della-vasca.appspot.com",
    messagingSenderId: "924753798835",
    appId: "1:924753798835:web:fc21f386c666caf37f32c6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Variabili elementi UI
  const userPhoto = document.getElementById('userPhoto');
  const nicknameEl = document.getElementById('nickname');
  const drinkCountNumber = document.getElementById('drinkCountNumber');
  const totalDrinksEl = document.getElementById('totalDrinks');
  const rankingEl = document.getElementById('ranking');
  const banner = document.getElementById('banner');
  const passwordInput = document.getElementById('passwordInput');
  const resetBtn = document.getElementById('resetBtn');
  const errorMsg = document.getElementById('errorMsg');

  // Password admin per azzerare
  const ADMIN_PASSWORD = "tua_password_admin";

  // Prendiamo il nfcCode dalla query string (esempio: ?nfcCode=ABC123)
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const nfcCode = getQueryParam('nfcCode');
  if (!nfcCode) {
    alert('Errore: codice NFC non fornito');
    location.href = 'login_clienti.html'; // reindirizza al login se manca nfcCode
  }

  // Stato cliente
  let userDocId = null;

  // Funzione per aggiornare UI cliente
  async function loadUserData() {
    const q = query(collection(db, "users"), orderBy("nfcCode"));
    // Cerchiamo il cliente con nfcCode uguale
    const qUser = query(collection(db, "users"));
    const snapshot = await getDocs(qUser);
    let found = null;
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if(data.nfcCode === nfcCode){
        found = { id: docSnap.id, data };
      }
    });
    if(!found){
      alert('Cliente non trovato.');
      location.href = 'login_clienti.html';
      return;
    }
    userDocId = found.id;
    const data = found.data;

    // Aggiorna UI
    nicknameEl.textContent = data.nickname || "Cliente";
    userPhoto.src = data.photoUrl || "https://via.placeholder.com/120?text=No+Photo";
    drinkCountNumber.textContent = data.drinkCount || 0;
    totalDrinksEl.textContent = data.totalDrinks || 0;

    updateRanking();

    // Setup listener realtime su utente per drinkCount e totalDrinks
    const userRef = doc(db, "users", userDocId);
    onSnapshot(userRef, docSnap => {
      if(!docSnap.exists()) return;
      const d = docSnap.data();
      drinkCountNumber.textContent = d.drinkCount || 0;
      totalDrinksEl.textContent = d.totalDrinks || 0;
      if ((d.drinkCount || 0) >= 10) {
        showBanner();
      } else {
        hideBanner();
      }
      updateRanking();
    });
  }

  // Calcola e mostra la classifica in base a totalDrinks
  async function updateRanking() {
    const usersCol = collection(db, "users");
    const qRanking = query(usersCol, orderBy("totalDrinks", "desc"));
    const snapshot = await getDocs(qRanking);
    let rank = 1;
    let userRank = null;
    snapshot.forEach(docSnap => {
      if (docSnap.id === userDocId) {
        userRank = rank;
      }
      rank++;
    });
    rankingEl.textContent = userRank ? `Classifica: #${userRank}` : "Classifica: --";
  }

  // Mostra banner omaggio
  function showBanner() {
    banner.style.display = 'flex';
    passwordInput.value = '';
    errorMsg.textContent = '';
    passwordInput.focus();
  }

  // Nasconde banner
  function hideBanner() {
    banner.style.display = 'none';
    passwordInput.value = '';
    errorMsg.textContent = '';
  }

  // Reset contatori dopo conferma password
  resetBtn.addEventListener('click', async () => {
    const pass = passwordInput.value.trim();
    if (pass !== ADMIN_PASSWORD) {
      errorMsg.textContent = 'Password errata!';
      return;
    }
    errorMsg.textContent = '';

    // Reset drinkCount a 0, incrementa totalDrinks di 1
    const userRef = doc(db, "users", userDocId);
    const userSnap = await getDoc(userRef);
    if(userSnap.exists()){
      const data = userSnap.data();
      const currentTotal = data.totalDrinks || 0;
      try {
        await updateDoc(userRef, {
          drinkCount: 0,
          totalDrinks: currentTotal + 1
        });
        hideBanner();
      } catch(e) {
        errorMsg.textContent = 'Errore nel reset: ' + e.message;
      }
    }
  });

  // Simulazione aggiornamento automatico drinkCount da NFC (per test)
  // In realtÃ , il counting deve avvenire lato backend o tramite lettura NFC device.
  // Qui aggiungiamo un listener temporaneo per aumentare il count col tasto D (solo per test)
  document.addEventListener('keydown', async (e) => {
    if(e.key === 'd' && userDocId){
      const userRef = doc(db, "users", userDocId);
      const userSnap = await getDoc(userRef);
      if(userSnap.exists()){
        const data = userSnap.data();
        let currentCount = data.drinkCount || 0;
        if(currentCount < 10){
          currentCount++;
          await updateDoc(userRef, { drinkCount: currentCount });
        }
      }
    }
  });

  loadUserData();
</script>

</body>
</html>
