<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Bathpipe Fidelity</title>
  <style>
    /* Stessi stili del precedente esempio */
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #171716;
      color: #EACE3E;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #D69327;
      margin-bottom: 10px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
    }
    #searchInput {
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      width: 250px;
      background-color: #2A2A29;
      color: #EACE3E;
    }
    select {
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      background-color: #2A2A29;
      color: #EACE3E;
      cursor: pointer;
    }
    #dataList table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      box-shadow: 0 0 10px rgba(214,147,39,0.5);
    }
    #dataList th, #dataList td {
      border: 2px solid #D69327;
      padding: 12px;
      text-align: center;
      vertical-align: middle;
    }
    #dataList th {
      background-color: #2A2A29;
      cursor: pointer;
      user-select: none;
    }
    img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #D69327;
      object-fit: cover;
    }
    td.actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    button {
      background-color: #A2231A;
      color: #EACE3E;
      font-weight: 700;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 70px;
    }
    button:hover {
      background-color: #D69327;
      color: #171716;
    }
    #logoutBtn {
      margin-bottom: 15px;
      min-width: 100px;
    }
    #editModal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #editModalContent {
      background-color: #1F1F1E;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      color: #EACE3E;
      position: relative;
      box-shadow: 0 0 15px #D69327;
    }
    #editModalContent label {
      display: block;
      margin-top: 10px;
      font-weight: 700;
      color: #D69327;
      text-align: left;
    }
    #editModalContent input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      margin-top: 5px;
      font-size: 1rem;
      background-color: #2A2A29;
      color: #EACE3E;
    }
    #editModalContent button {
      width: 100%;
      margin-top: 15px;
    }
    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #D69327;
      font-size: 1.5rem;
      cursor: pointer;
      font-weight: 700;
    }
  </style>
</head>
<body>

  <h1>Area Admin</h1>
  <button id="logoutBtn">Logout</button>

  <div id="controls">
    <input type="text" id="searchInput" placeholder="Cerca per nickname o codice NFC..." />
    <select id="sortField">
      <option value="timestamp">Ordina per Data Registrazione</option>
      <option value="drinkCount">Ordina per Drink Count</option>
    </select>
    <select id="sortOrder">
      <option value="asc">Ascendente</option>
      <option value="desc" selected>Discendente</option>
    </select>
  </div>

  <div id="dataList">Caricamento dati...</div>

  <!-- Modale modifica -->
  <div id="editModal">
    <div id="editModalContent">
      <button id="closeModal">&times;</button>
      <h2>Modifica Utente</h2>
      <form id="editForm">
        <label for="editFoto">URL Foto</label>
        <input type="text" id="editFoto" name="editFoto" placeholder="URL immagine" />

        <label for="editNickname">Nickname</label>
        <input type="text" id="editNickname" name="editNickname" required />

        <label for="editCodiceNFC">Codice NFC</label>
        <input type="text" id="editCodiceNFC" name="editCodiceNFC" required />

        <label for="editDataRegistrazione">Data Registrazione</label>
        <input type="datetime-local" id="editDataRegistrazione" name="editDataRegistrazione" required />

        <label for="editDrinkCount">Drink Count</label>
        <input type="number" id="editDrinkCount" name="editDrinkCount" min="0" required />

        <button type="submit">Salva Modifiche</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtSDqUKdsmID1MrN07BKoo6ZFe6ymisSg",
      authDomain: "il-club-della-vasca.firebaseapp.com",
      projectId: "il-club-della-vasca",
      storageBucket: "il-club-della-vasca.appspot.com",
      messagingSenderId: "924753798835",
      appId: "1:924753798835:web:fc21f386c666caf37f32c6",
      measurementId: "G-EZHK6WKYWW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const dataList = document.getElementById('dataList');
    const logoutBtn = document.getElementById('logoutBtn');
    const editModal = document.getElementById('editModal');
    const closeModalBtn = document.getElementById('closeModal');
    const editForm = document.getElementById('editForm');

    const searchInput = document.getElementById('searchInput');
    const sortFieldSelect = document.getElementById('sortField');
    const sortOrderSelect = document.getElementById('sortOrder');

    let currentEditDocId = null;
    let clientiData = [];

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadData();
      }
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      });
    });

    closeModalBtn.addEventListener('click', () => {
      editModal.style.display = 'none';
    });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!currentEditDocId) return;

      const foto = editForm.editFoto.value.trim();
      const nickname = editForm.editNickname.value.trim();
      const nfc = editForm.editCodiceNFC.value.trim();
      const dataRegistrazioneStr = editForm.editDataRegistrazione.value;
      const drinkCount = parseInt(editForm.editDrinkCount.value, 10);

      if (!nickname || !nfc || !dataRegistrazioneStr || isNaN(drinkCount)) {
        alert("Compila tutti i campi correttamente.");
        return;
      }

      try {
        const docRef = doc(db, "clienti", currentEditDocId);
        const dataRegistrazione = new Date(dataRegistrazioneStr);

        await updateDoc(docRef, {
          foto,
          nickname,
          nfc,
          timestamp: Timestamp.fromDate(dataRegistrazione),
          drinkCount
        });

        alert("Utente aggiornato con successo!");
        editModal.style.display = "none";
        loadData();
      } catch (error) {
        alert("Errore aggiornamento: " + error.message);
        console.error(error);
      }
    });

    searchInput.addEventListener('input', () => {
      renderTable(filterAndSort(clientiData));
    });

    sortFieldSelect.addEventListener('change', () => {
      renderTable(filterAndSort(clientiData));
    });

    sortOrderSelect.addEventListener('change', () => {
      renderTable(filterAndSort(clientiData));
    });

    async function loadData() {
      try {
        const colRef = collection(db, "clienti");
        const snapshot = await getDocs(colRef);

        clientiData = [];

        snapshot.forEach(docSnap => {
          const data = docSnap.data();

          clientiData.push({
            id: docSnap.id,
            foto: data.foto || '',
            nickname: data.nickname || '',
            nfc: data.nfc || '',
            timestamp: data.timestamp ? data.timestamp.toDate() : null,
            drinkCount: data.drinkCount || 0
          });
        });

        if (clientiData.length === 0) {
          dataList.innerHTML = "<p>Nessun dato trovato.</p>";
          return;
        }

        renderTable(clientiData);

      } catch (error) {
        dataList.innerHTML = `<p>Errore caricamento dati: ${error.message}</p>`;
      }
    }

    function filterAndSort(data) {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const field = sortFieldSelect.value;
      const order = sortOrderSelect.value;

      let filtered = data.filter(item => {
        return (
          item.nickname.toLowerCase().includes(searchTerm) ||
          item.nfc.toLowerCase().includes(searchTerm)
        );
      });

      filtered.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];

        if (field === "timestamp") {
          valA = valA ? valA.getTime() : 0;
          valB = valB ? valB.getTime() : 0;
        }

        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
      });

      return filtered;
    }

    function renderTable(data) {
      let html = `<table>
        <thead>
          <tr>
            <th>Foto</th>
            <th>Nickname</th>
            <th>Codice NFC</th>
            <th>Data Registrazione</th>
            <th>Drink Count</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>`;

      data.forEach(item => {
        const dateStr = item.timestamp ? item.timestamp.toLocaleString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';

        html += `
          <tr>
            <td><img src="${item.foto || 'https://via.placeholder.com/50'}" alt="Foto ${item.nickname}" /></td>
            <td>${item.nickname}</td>
            <td>${item.nfc}</td>
            <td>${dateStr}</td>
            <td>${item.drinkCount}</td>
            <td class="actions">
              <button onclick="openEditModal('${item.id}')">Modifica</button>
              <button onclick="deleteUser('${item.id}')">Elimina</button>
            </td>
          </tr>
        `;
      });

      html += "</tbody></table>";

      dataList.innerHTML = html;
    }

    window.openEditModal = async function(docId) {
      try {
        const docRef = doc(db, "clienti", docId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();

          currentEditDocId = docId;
          editForm.editFoto.value = data.foto || '';
          editForm.editNickname.value = data.nickname || '';
          editForm.editCodiceNFC.value = data.nfc || '';

          if(data.timestamp) {
            const date = data.timestamp.toDate();
            const localISOTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0,16);
            editForm.editDataRegistrazione.value = localISOTime;
          } else {
            editForm.editDataRegistrazione.value = '';
          }

          editForm.editDrinkCount.value = data.drinkCount || 0;

          editModal.style.display = "flex";
        } else {
          alert("Utente non trovato.");
        }
      } catch (error) {
        alert("Errore nel caricamento dati utente: " + error.message);
      }
    }

    window.deleteUser = async function(docId) {
      if (confirm("Sei sicuro di voler eliminare questo utente?")) {
        try {
          await deleteDoc(doc(db, "clienti", docId));
          alert("Utente eliminato");
          loadData();
        } catch (error) {
          alert("Errore eliminazione: " + error.message);
          console.error(error);
        }
      }
    }
  </script>
</body>
</html>
