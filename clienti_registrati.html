<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Bathpipe Fidelity</title>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #171716;
      color: #EACE3E;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #D69327; margin-bottom: 10px; }
    #controls {
      display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px;
    }
    #searchInput, select {
      padding: 8px; border-radius: 6px; border: none; font-size: 1rem;
      background-color: #2A2A29; color: #EACE3E;
    }
    #searchInput { width: 250px; }
    #dataList table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
      box-shadow: 0 0 10px rgba(214,147,39,0.5);
    }
    #dataList th, #dataList td {
      border: 2px solid #D69327; padding: 12px; text-align: center; vertical-align: middle;
    }
    #dataList th {
      background-color: #2A2A29; cursor: pointer; user-select: none;
    }
    img {
      width: 50px; height: 50px; border-radius: 50%;
      border: 2px solid #D69327; object-fit: cover;
    }
    td.actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 12px; /* allineato al padding delle celle */
    }
    button.actionBtn {
      background-color: #A2231A;
      color: #EACE3E;
      font-weight: 700;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 70px;
    }
    button.actionBtn:hover {
      background-color: #D69327;
      color: #171716;
    }
    /* Stile tasto Salva Modifiche modale */
    #editModalContent button[type="submit"] {
      background-color: #A2231A;
      color: #EACE3E;
      font-weight: 700;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 130px;
      margin-top: 15px;
    }
    #editModalContent button[type="submit"]:hover {
      background-color: #D69327;
      color: #171716;
    }
    #editModal {
      display: none; position: fixed; z-index: 999; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
      justify-content: center; align-items: center;
    }
    #editModalContent {
      background-color: #1F1F1E; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 400px; color: #EACE3E; position: relative;
      box-shadow: 0 0 15px #D69327;
    }
    #editModalContent label {
      display: block; margin-top: 10px; font-weight: 700; color: #D69327; text-align: left;
    }
    #editModalContent input {
      width: 100%; padding: 8px; border-radius: 6px; border: none; margin-top: 5px;
      font-size: 1rem; background-color: #2A2A29; color: #EACE3E;
    }
    #closeModal {
      position: absolute; top: 10px; right: 15px; background: none;
      border: none; color: #D69327; font-size: 1.5rem; cursor: pointer; font-weight: 700;
    }
  </style>
</head>
<body>

  <h1>Area Admin</h1>

  <div id="controls">
    <input type="text" id="searchInput" placeholder="Cerca per nickname o codice NFC..." />
    <select id="sortField">
      <option value="timestamp">Ordina per Data Registrazione</option>
      <option value="drinkCount">Ordina per Drink Count</option>
      <option value="drinkPromoCount">Ordina per Drink Promo (10+1)</option>
    </select>
    <select id="sortOrder">
      <option value="asc">Ascendente</option>
      <option value="desc" selected>Discendente</option>
    </select>
    <button id="backHomeBtn" class="actionBtn" style="min-width: 130px;">Torna Home Admin</button>
  </div>

  <div id="dataList">Caricamento dati...</div>

  <!-- Modale modifica -->
  <div id="editModal">
    <div id="editModalContent">
      <button id="closeModal">&times;</button>
      <h2>Modifica Utente</h2>
      <form id="editForm">
        <label for="editFoto">URL Foto</label>
        <input type="text" id="editFoto" name="editFoto" placeholder="URL immagine" />

        <label for="editNickname">Nickname</label>
        <input type="text" id="editNickname" name="editNickname" required />

        <label for="editCodiceNFC">Codice NFC</label>
        <input type="text" id="editCodiceNFC" name="editCodiceNFC" required />

        <label for="editDataRegistrazione">Data Registrazione</label>
        <input type="datetime-local" id="editDataRegistrazione" name="editDataRegistrazione" required />

        <label for="editDrinkCount">Drink Count Generico</label>
        <input type="number" id="editDrinkCount" name="editDrinkCount" min="0" required />

        <label for="editDrinkPromoCount">Drink Promo (10+1)</label>
        <input type="number" id="editDrinkPromoCount" name="editDrinkPromoCount" min="0" max="10" required />

        <button type="submit">Salva Modifiche</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtSDqUKdsmID1MrN07BKoo6ZFe6ymisSg",
      authDomain: "il-club-della-vasca.firebaseapp.com",
      projectId: "il-club-della-vasca",
      storageBucket: "il-club-della-vasca.appspot.com",
      messagingSenderId: "924753798835",
      appId: "1:924753798835:web:fc21f386c666caf37f32c6",
      measurementId: "G-EZHK6WKYWW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const dataList = document.getElementById('dataList');
    const editModal = document.getElementById('editModal');
    const closeModalBtn = document.getElementById('closeModal');
    const editForm = document.getElementById('editForm');

    const searchInput = document.getElementById('searchInput');
    const sortFieldSelect = document.getElementById('sortField');
    const sortOrderSelect = document.getElementById('sortOrder');
    const backHomeBtn = document.getElementById('backHomeBtn');

    let currentEditDocId = null;
    let clientiData = [];

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "admin_login.html";
      } else {
        loadData();
      }
    });

    backHomeBtn.addEventListener('click', () => {
      window.location.href = "home_admin.html";
    });

    closeModalBtn.addEventListener('click', () => { editModal.style.display = 'none'; });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentEditDocId) return;

      const foto = editForm.editFoto.value.trim();
      const nickname = editForm.editNickname.value.trim();
      const nfc = editForm.editCodiceNFC.value.trim();
      const dataRegistrazioneStr = editForm.editDataRegistrazione.value;
      const drinkCount = parseInt(editForm.editDrinkCount.value, 10);
      const drinkPromoCount = parseInt(editForm.editDrinkPromoCount.value, 10);

      if (!nickname || !nfc || !dataRegistrazioneStr || isNaN(drinkCount) || isNaN(drinkPromoCount) || drinkPromoCount < 0 || drinkPromoCount > 10) {
        alert("Compila tutti i campi correttamente.");
        return;
      }

      try {
        const docRef = doc(db, "clienti", currentEditDocId);
        const dataRegistrazione = new Date(dataRegistrazioneStr);

        await updateDoc(docRef, {
          foto,
          nickname,
          nfc,
          timestamp: Timestamp.fromDate(dataRegistrazione),
          drinkCount,
          drinkPromoCount
        });

        alert("Utente aggiornato con successo!");
        editModal.style.display = "none";
        loadData();
      } catch (error) {
        alert("Errore aggiornamento: " + error.message);
      }
    });

    searchInput.addEventListener('input', () => { renderTable(filterAndSort(clientiData)); });
    sortFieldSelect.addEventListener('change', () => { renderTable(filterAndSort(clientiData)); });
    sortOrderSelect.addEventListener('change', () => { renderTable(filterAndSort(clientiData)); });

    async function loadData() {
      try {
        const colRef = collection(db, "clienti");
        const snapshot = await getDocs(colRef);

        clientiData = snapshot.docs.map(docSnap => ({
          id: docSnap.id,
          foto: docSnap.data().foto || '',
          nickname: docSnap.data().nickname || '',
          nfc: docSnap.data().nfc || '',
          timestamp: docSnap.data().timestamp ? docSnap.data().timestamp.toDate() : null,
          drinkCount: docSnap.data().drinkCount || 0,
          drinkPromoCount: docSnap.data().drinkPromoCount || 0
        }));

        if (!clientiData.length) {
          dataList.innerHTML = "<p>Nessun dato trovato.</p>";
          return;
        }

        renderTable(clientiData);
      } catch (error) {
        dataList.innerHTML = `<p>Errore caricamento dati: ${error.message}</p>`;
      }
    }

    function filterAndSort(data) {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const field = sortFieldSelect.value;
      const order = sortOrderSelect.value;

      let filtered = data.filter(item =>
        item.nickname.toLowerCase().includes(searchTerm) ||
        item.nfc.toLowerCase().includes(searchTerm)
      );

      filtered.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];

        if (field === "timestamp") {
          valA = valA ? valA.getTime() : 0;
          valB = valB ? valB.getTime() : 0;
        }

        return order === 'asc' ? valA - valB : valB - valA;
      });

      return filtered;
    }

    function renderTable(data) {
      let html = `<table>
        <thead>
          <tr>
            <th>Foto</th>
            <th>Nickname</th>
            <th>Codice NFC</th>
            <th>Data Registrazione</th>
            <th>Drink Count Generico</th>
            <th>Drink Promo (10+1)</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>`;

      for (const item of data) {
        const dateStr = item.timestamp ? item.timestamp.toLocaleString('it-IT') : '';
        html += `<tr>
          <td><img src="${item.foto || 'https://via.placeholder.com/50'}" alt="Foto"/></td>
          <td>${item.nickname}</td>
          <td>${item.nfc}</td>
          <td>${dateStr}</td>
          <td>${item.drinkCount}</td>
          <td>${item.drinkPromoCount}</td>
          <td class="actions">
            <button class="actionBtn" onclick="openEditModal('${item.id}')">Modifica</button>
            <button class="actionBtn" onclick="deleteUser('${item.id}', '${item.nickname}')">Elimina</button>
          </td>
        </tr>`;
      }

      html += "</tbody></table>";
      dataList.innerHTML = html;
    }

    window.openEditModal = function(id) {
      const user = clientiData.find(u => u.id === id);
      if (!user) return;

      currentEditDocId = id;

      editForm.editFoto.value = user.foto || '';
      editForm.editNickname.value = user.nickname || '';
      editForm.editCodiceNFC.value = user.nfc || '';
      editForm.editDataRegistrazione.value = user.timestamp ? toInputDateTimeValue(user.timestamp) : '';
      editForm.editDrinkCount.value = user.drinkCount || 0;
      editForm.editDrinkPromoCount.value = user.drinkPromoCount || 0;

      editModal.style.display = "flex";
    };

    window.deleteUser = async function(id, nickname) {
      if (!confirm(`Eliminare definitivamente l'utente "${nickname}"?`)) return;

      try {
        await deleteDoc(doc(db, "clienti", id));
        alert("Utente eliminato con successo.");
        loadData();
      } catch (error) {
        alert("Errore eliminazione: " + error.message);
      }
    };

    function toInputDateTimeValue(date) {
      const pad = n => n.toString().padStart(2, '0');
      const yyyy = date.getFullYear();
      const MM = pad(date.getMonth() + 1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
    }
  </script>
</body>
</html>
