<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accesso Cliente - Club della Vasca</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');
  @font-face {
    font-family: 'Ransel';
    src: url('/fonts/Ransel.ttf') format('truetype');
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Ransel', 'Montserrat', sans-serif;
    background-color: #171716;
    color: #EACE3E;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    position: relative;
  }
  /* Pulsante indietro */
  .back-btn {
    position: absolute;
    top: 15px;
    left: 15px;
    font-size: 0.9rem;
    color: #D69327;
    text-decoration: none;
    background: none;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  .back-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .container {
    background-color: #1F1F1E;
    padding: 30px;
    border-radius: 10px;
    width: 320px;
    text-align: center;
  }
  h1 {
    color: #D69327;
    margin-bottom: 25px;
  }
  label {
    display: block;
    text-align: left;
    margin-bottom: 5px;
    color: #D69327;
    font-weight: bold;
    font-size: 0.9rem;
  }
  input[type="email"],
  input[type="password"],
  input[type="text"] {
    width: 100%;
    padding: 12px 40px 12px 12px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    background-color: #2A2A29;
    color: #EACE3E;
    font-family: 'Ransel', 'Montserrat', sans-serif;
    position: relative;
  }
  .password-wrapper {
    position: relative;
    width: 100%;
  }
  .toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    width: 24px;
    height: 24px;
    fill: #D69327;
    background: transparent;
    transition: fill 0.3s ease;
  }
  .toggle-password:hover {
    fill: #EACE3E;
  }
  button {
    background-color: #A2231A;
    color: #EACE3E;
    font-weight: bold;
    border: none;
    padding: 12px;
    width: 100%;
    font-size: 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    font-family: 'Ransel', 'Montserrat', sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #D69327;
    color: #171716;
  }
  .switch-btn, .forgot-pass-btn {
    background: none;
    border: none;
    color: #D69327;
    cursor: pointer;
    margin-top: 12px;
    text-decoration: underline;
    font-size: 0.9rem;
  }
  #errorMsg {
    margin-top: 12px;
    color: #D69327;
    min-height: 1.2em;
  }
</style>
</head>
<body>

<a href="index.html" class="back-btn">Indietro</a>

<div class="container">
  <h1 id="formTitle">Accesso Cliente</h1>
  <form id="authForm" autocomplete="off">
    <label for="email">Email</label>
    <input type="email" id="email" name="email" placeholder="esempio@dominio.com" required />

    <label for="password">Password</label>
    <div class="password-wrapper">
      <input type="password" id="password" name="password" placeholder="Inserisci password" required />
      <svg id="togglePassword" class="toggle-password" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
        <circle cx="12" cy="12" r="2.5"/>
      </svg>
    </div>

    <div id="confirmPasswordWrapper" style="display:none;">
      <label for="confirmPassword">Conferma Password</label>
      <div class="password-wrapper">
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Conferma password" />
        <svg id="toggleConfirmPassword" class="toggle-password" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
          <circle cx="12" cy="12" r="2.5"/>
        </svg>
      </div>
    </div>

    <button type="submit" id="submitBtn">Accedi</button>
  </form>

  <button class="forgot-pass-btn" id="forgotPassBtn" style="display:inline;">Password dimenticata?</button>
  <button class="switch-btn" id="switchBtn">Non hai un account? Registrati</button>
  <div id="errorMsg"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtSDqUKdsmID1MrN07BKoo6ZFe6ymisSg",
    authDomain: "il-club-della-vasca.firebaseapp.com",
    projectId: "il-club-della-vasca",
    storageBucket: "il-club-della-vasca.appspot.com",
    messagingSenderId: "924753798835",
    appId: "1:924753798835:web:fc21f386c666caf37f32c6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authForm = document.getElementById('authForm');
  const switchBtn = document.getElementById('switchBtn');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const errorMsg = document.getElementById('errorMsg');
  const forgotPassBtn = document.getElementById('forgotPassBtn');

  const passwordInput = document.getElementById('password');
  const confirmPasswordWrapper = document.getElementById('confirmPasswordWrapper');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const togglePassword = document.getElementById('togglePassword');
  const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');

  let isLogin = true;

  switchBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    if (isLogin) {
      formTitle.textContent = "Accesso Cliente";
      submitBtn.textContent = "Accedi";
      switchBtn.textContent = "Non hai un account? Registrati";
      confirmPasswordWrapper.style.display = "none";
      confirmPasswordInput.required = false;
      forgotPassBtn.style.display = "inline";
    } else {
      formTitle.textContent = "Registrazione Cliente";
      submitBtn.textContent = "Registrati";
      switchBtn.textContent = "Hai già un account? Accedi";
      confirmPasswordWrapper.style.display = "block";
      confirmPasswordInput.required = true;
      forgotPassBtn.style.display = "none";
    }
    errorMsg.textContent = "";
    authForm.reset();
    passwordInput.type = "password";
    confirmPasswordInput.type = "password";
    updateToggleIcon(togglePassword, "password");
    updateToggleIcon(toggleConfirmPassword, "password");
  });

  togglePassword.addEventListener('click', () => {
    toggleInputVisibility(passwordInput, togglePassword);
  });
  toggleConfirmPassword.addEventListener('click', () => {
    toggleInputVisibility(confirmPasswordInput, toggleConfirmPassword);
  });

  function toggleInputVisibility(input, toggleIcon) {
    if (input.type === "password") {
      input.type = "text";
      updateToggleIcon(toggleIcon, "text");
    } else {
      input.type = "password";
      updateToggleIcon(toggleIcon, "password");
    }
  }

  function updateToggleIcon(svgElement, type) {
    svgElement.style.fill = (type === "text") ? "#EACE3E" : "#D69327";
  }

  forgotPassBtn.addEventListener('click', () => {
    const email = prompt("Inserisci la tua email per il reset della password:");
    if(email){
      sendPasswordResetEmail(auth, email)
        .then(() => {
          alert("Email di reset inviata.");
        })
        .catch(error => {
          errorMsg.textContent = error.message;
        });
    }
  });

  authForm.addEventListener('submit', async e => {
    e.preventDefault();
    errorMsg.textContent = "";

    const email = authForm.email.value.trim();
    const password = authForm.password.value;

    if (!email || !password) {
      errorMsg.textContent = "Compila tutti i campi richiesti.";
      return;
    }

    if(!isLogin){
      const confirmPassword = authForm.confirmPassword.value;
      if(password !== confirmPassword){
        errorMsg.textContent = "Le password non corrispondono.";
        return;
      }

      try {
        // Controllo Firestore se la mail è registrata dallo staff (nella collezione 'clienti', documento con id email)
        const clienteRef = doc(db, "clienti", email);
        const clienteSnap = await getDoc(clienteRef);

        if (!clienteSnap.exists()) {
          errorMsg.textContent = "Registrazione non consentita. Contatta lo staff per attivare l’account.";
          return;
        }

        await createUserWithEmailAndPassword(auth, email, password);
        alert("Registrazione avvenuta con successo!");
        authForm.reset();
        switchBtn.click();

      } catch (error) {
        errorMsg.textContent = error.message;
      }

    } else {
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("Accesso effettuato con successo!");
          authForm.reset();
          window.location.href = 'area_cliente.html';
        })
        .catch(error => {
          errorMsg.textContent = error.message;
        });
    }
  });

</script>

</body>
</html>
